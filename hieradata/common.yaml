---
classes:
  - apt::unattended_upgrades
  - govuk_apt::unused_kernels
  - gds_accounts
  - harden
  - puppet
  - ssh::server
  - ufw
  - gds_sudo
  - nginx
  - mirror_environment
  - mirror_environment::cron
  - mirror_environment::fail2ban
  - mirror_environment::firewall
  - mirror_environment::mounts
  - mirror_environment::user
  - mirror_environment::clamdscan
  - mirror_environment::supported_kernel
  - mirror_environment::nrpe
  - resolvconf
  - rssh
  - clamav
  - nrpe

apt::unattended_upgrades::auto_reboot: true

puppet::puppet_ensure: '3.2.3-1puppetlabs1'
puppet::facter_ensure: '1.7.2-1puppetlabs1'
puppet::cron_command: '/opt/puppet/tools/puppet-apply --environment %{environment}'
puppet::cron_ensure: 'present'

mirror_environment::package_array:
  - lvm2
  - rsync
  - curl
  - update-notifier-common

rssh::users:
  - 'mirror-rsync:022:100000'

nginx::server_tokens: 'off'
nginx::confd_purge: true
nginx::http_cfg_append:
  gzip_vary: 'on'
nginx::nginx_vhosts:
  'www-origin':
    server_name:
      - 'www-origin.mirror.*'
    www_root: '/srv/mirror_data/www.gov.uk'
    listen_port: 443
    ssl:      true
    ssl_key:  '/etc/nginx/ssl/mirror.key'
    ssl_cert: '/etc/nginx/ssl/mirror.cert'
    ssl_protocols: 'TLSv1 TLSv1.1 TLSv1.2'
    location_cfg_prepend:
      expires: '15m'
      error_page: '403 500 503 504 =503 /error/503.html'
      rewrite: '^/(.*)/$ https://www.gov.uk/$1 permanent'
    try_files:
      - '$uri/index.html'
      - '$uri.html'
      - '$uri'
      - '=503'
  'assets-origin':
    server_name:
      - 'assets-origin.mirror.*'
    www_root: '/srv/mirror_data/assets.digital.cabinet-office.gov.uk'
    listen_port: 443
    ssl:  true
    ssl_key: '/etc/nginx/ssl/mirror.key'
    ssl_cert: '/etc/nginx/ssl/mirror.cert'
    ssl_protocols: 'TLSv1 TLSv1.1 TLSv1.2'
    location_cfg_prepend:
      expires: '15m'
      error_page: '403 500 503 504 =503 /error/503.html'
    try_files:
      - '$uri'
      - '=503'

nginx::nginx_locations:
  'canary':
    vhost: 'assets-origin'
    priority: 900
    location: /__canary__
    location_custom_cfg:
      - 'default_type text/plain'
      - 'add_header cache-control "max-age=0, no-store, no-cache"'
      - 'return 200 "Mirror OK\n"'

mirror_environment::supported_kernel::hwe_ver: 'trusty'

mirror_environment::mounts::mirror_data: '/srv/mirror_data'
mirror_environment::mounts::username: 'mirror-rsync'

mirror_environment::user::username: 'mirror-rsync'
mirror_environment::user::ssh_key: 'AAAAB3NzaC1yc2EAAAABIwAAAQEAw/ksvUhzrUVVbupDXEwz4J2K8Yz515pxhRLpfx6oGruM/hj4wVJ5uPt+4IL5k0sLXxRH0X/VXuK2zBV2fSnPP4cNUZiFrPbN1gea945dGvGIstLMZfsw8Md3jN4i8UXZFBriUfjQT7APLGEsQ+fl+Lzuhpp1nq2oWKem28moAxQkxU2ShPQhP/kzRkTrNbiusOFE4YQN4seZRJEtZ22p+qSVAPVyc2mfJHr6gdVNO3dMBdD7Ud9m3L5AeD7GNA/r2DiJViIplipRMvJJ0w3KkCnTWHiw3C0tXjyAMIH3jXqIJVqUej7Jum3FzixQrFgBR88XkPzlR0qHvR73HBSeZQ=='

gds_sudo::sudoers:
  group_sudo:
    users: '%sudo'
    tags:
      - 'NOPASSWD'

gds_accounts::groups:
  - gds
  - sudo

gds_accounts::accounts:
  alexmuller:
    comment: Alex Muller
    ssh_key: replace-key-cve-2016-0777
  bob:
    comment: bob walker
    ssh_key: replace-key-cve-2016-0777
  bradleyw:
    comment: Bradley Wright
    ssh_key: replace-key-cve-2016-0777
  daivaughan:
    comment: Dai Vaughan
    ssh_key: replace-key-cve-2016-0777
  danielroseman:
    comment: Daniel Roseman
    ssh_key: replace-key-cve-2016-0777
  jamiec:
    comment: Jamie Cobbett
    ssh_key: replace-key-cve-2016-0777
  jennyduckett:
    comment: Jenny Duckett
    ssh_key: replace-key-cve-2016-0777
  joshmyers:
    comment: Josh Myers
    ssh_key: replace-key-cve-2016-0777
  mattbostock:
    comment: Matt Bostock
    ssh_key: replace-key-cve-2016-0777
  richardboulton:
    comment: Richard Boulton
    ssh_key: replace-key-cve-2016-0777
  timothymower:
    comment: Tim Mower
    ssh_key: replace-key-cve-2016-0777
  tombooth:
    comment: Tom Booth
    ssh_key: replace-key-cve-2016-0777
