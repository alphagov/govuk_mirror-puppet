---
classes:
  - apt::unattended_upgrades
  - clamav
  - gds_accounts
  - gds_sudo
  - govuk_apt::unused_kernels
  - harden
  - mirror_environment
  - mirror_environment::clamdscan
  - mirror_environment::cron
  - mirror_environment::firewall
  - mirror_environment::mounts
  - mirror_environment::nrpe
  - mirror_environment::supported_kernel
  - mirror_environment::user
  - nginx
  - nrpe
  - puppet
  - resolvconf
  - rssh
  - ssh::server
  - ufw

apt::unattended_upgrades::auto_reboot: true

puppet::puppet_ensure: '3.2.3-1puppetlabs1'
puppet::facter_ensure: '1.7.5-1puppetlabs1'
puppet::cron_command: '/opt/puppet/tools/puppet-apply --environment %{environment}'
puppet::cron_ensure: 'present'

mirror_environment::package_array:
  - lvm2
  - rsync
  - curl
  - update-notifier-common

rssh::users:
  - 'mirror-rsync:022:100000'

nginx::server_tokens: 'off'
nginx::confd_purge: true
nginx::http_cfg_append:
  gzip_vary: 'on'
nginx::nginx_vhosts:
  'www-origin':
    server_name:
      - 'www-origin.mirror.*'
    www_root: '/srv/mirror_data/www.gov.uk'
    listen_port: 443
    ssl:      true
    ssl_key:  '/etc/nginx/ssl/mirror.key'
    ssl_cert: '/etc/nginx/ssl/mirror.cert'
    ssl_protocols: 'TLSv1 TLSv1.1 TLSv1.2'
    location_cfg_prepend:
      expires: '15m'
      error_page: '403 500 503 504 =503 /error/503.html'
      rewrite: '^/(.*)/$ https://www.gov.uk/$1 permanent'
    try_files:
      - '$uri/index.html'
      - '$uri.html'
      - '$uri'
      - '=503'
  'assets-origin':
    server_name:
      - 'assets-origin.mirror.*'
    www_root: '/srv/mirror_data/assets.publishing.service.gov.uk'
    listen_port: 443
    ssl:  true
    ssl_key: '/etc/nginx/ssl/mirror.key'
    ssl_cert: '/etc/nginx/ssl/mirror.cert'
    ssl_protocols: 'TLSv1 TLSv1.1 TLSv1.2'
    location_cfg_prepend:
      expires: '15m'
      error_page: '403 500 503 504 =503 /error/503.html'
    try_files:
      - '$uri'
      - '=503'

nginx::nginx_locations:
  'canary':
    vhost: 'assets-origin'
    priority: 900
    location: /__canary__
    location_custom_cfg:
      - 'default_type text/plain'
      - 'add_header cache-control "max-age=0, no-store, no-cache"'
      - 'return 200 "Mirror OK\n"'
  'error-www':
    vhost: 'www-origin'
    priority: 900
    location: '= /error/503.html'
    location_custom_cfg:
      - 'root /srv/mirror_data'
  'error-assets':
    vhost: 'assets-origin'
    priority: 900
    location: '= /error/503.html'
    location_custom_cfg:
      - 'root /srv/mirror_data'

nrpe::allowed_hosts:
  - 127.0.0.1
  - 31.210.245.86

mirror_environment::supported_kernel::hwe_ver: 'trusty'

mirror_environment::mounts::mirror_data: '/srv/mirror_data'
mirror_environment::mounts::username: 'mirror-rsync'

mirror_environment::nrpe::mirror_data_mountpoint: '/srv/mirror_data'

mirror_environment::user::username: 'mirror-rsync'
mirror_environment::user::ssh_key: 'AAAAB3NzaC1yc2EAAAABIwAAAQEAw/ksvUhzrUVVbupDXEwz4J2K8Yz515pxhRLpfx6oGruM/hj4wVJ5uPt+4IL5k0sLXxRH0X/VXuK2zBV2fSnPP4cNUZiFrPbN1gea945dGvGIstLMZfsw8Md3jN4i8UXZFBriUfjQT7APLGEsQ+fl+Lzuhpp1nq2oWKem28moAxQkxU2ShPQhP/kzRkTrNbiusOFE4YQN4seZRJEtZ22p+qSVAPVyc2mfJHr6gdVNO3dMBdD7Ud9m3L5AeD7GNA/r2DiJViIplipRMvJJ0w3KkCnTWHiw3C0tXjyAMIH3jXqIJVqUej7Jum3FzixQrFgBR88XkPzlR0qHvR73HBSeZQ=='

gds_sudo::sudoers:
  group_sudo:
    users: '%sudo'
    tags:
      - 'NOPASSWD'

gds_accounts::groups:
  - gds
  - sudo

gds_accounts::accounts:
  christopherbaines:
    comment: Christopher Baines
    ssh_key: AAAAB3NzaC1yc2EAAAADAQABAAACAQCudd/9XjKFYQc4racSyvGyEjjEWB9lxGUE1xals8StpoQkeNHgvVzy7On3eJRalv05C8gG19F6qmFJ6WKRaEvERmm57rqVBzbOJjTkwuVkfCmyWGg0iVRgIBDrrA5beYS5kohaVnPl4JGvyDDHTesTNvAePdBcdCo6NvGO5DhCanINWrWwH7Vz+IZQgkOufHc1NLjSFjMpXaxhsSeUnAbLLYuMUWVpjrrWRCj9ULiJ+8hjKiar+Omh/LVfsebgEtXZOQ9ggz3FIrDJw3l1vVUDj1XN8WOZ02NHNz09JfP3ywG+cVpM5a5e7BD+WEFI68WZSayiDF4F5oGOq+GFLx6/Yvc9H9CUw7IKbCoDWjgNuzBKRkrISGtOMB+B6UE+7EIM8iBY6gVv5jyBl/CkT51a3lw0mrkrpx+UkJE1GV6hiQd8w8huixp8D3I17qrfIR5Ifk0FekPFdoT/+UHQVio8h4l5P95sBKHt8Sy+Bx719iUnxYqQlaZvk6ScrTMK8FZ5ltzT49nwOYueXDvJ6wUV4tLwzuGBn/xW1rDYADCUKRav8RLWHfEpcFhQuL++pFCm55B4hiv0VlHqA3C5bnvIVl+v3UeSe1ClF+NlSTNugRHQTmgc3ImBipLveUP9++PzcRk4VuKlR1kMLVV1sYsUklA1R3JnO38Vaeq07mOPMw==
  danielroseman:
    comment: Daniel Roseman
    ssh_key: AAAAB3NzaC1yc2EAAAADAQABAAACAQDcz+lw8fLHK2IHyIOs4w29QO0zT6I98l0m5JrapSsK9ZUASS2svj7EvinMdJJ2NQQ4fqhYMD67xB2gzhug/SEpYpIicg3aUDdQEJyQulWLigH9rRFYjFv5d6jkFkRUHc4XRd31PFc6tjTgpstzPaL1uO20XlDIaU1U2+LyUplENVkVtTuNqyVPfg8qjtzHGWswr16E8ouKtfzAuTAmkuVS19cjXiflSuXD5v8vXsVzpNbyoXDjoeu443ZY8MOavZMD/7ClrZd43m/Yi154I42xJ68uM+3R4uuU6OQgcOnNhwRnyJ21jFk7ohnipVmTxB5oUjXuh0gPQSfOkCQPvddwsd/0dmfLEKidAIrwcUllI0qngSjkei0M693Wn9zJmdYoyOTpksCpEsmSpeF5ALYOXedlZfa6WuJu7SxozfuaQScJONu5TZbIS5mM/1zRVwB15cdZ+qgH1WCG9wjFWTH3CerqfnMxqpB80nxHcKD6r/FJ7tRVpHY9CaW9iAjZ97d7Hh6MTb8Jksg1F0os0c/hSOChFX/hJpmeGnQIEdu4hE7U/zt7gVxalx6446BOPdDePDcPae8ngQAutRDNI6/MtL0QAcxDUEnW2KD9QVatvwEh3kdta+EJBUOiWAjEBlpMa34509mBI1H8JKa3wAxpQ0u9tzIzsXzoxsYiUPjXkQ==
  deanwilson:
    comment: Dean Wilson
    ssh_key: AAAAB3NzaC1yc2EAAAADAQABAAACAQDAmm4kdSdiwYnIhn9wcuNGmTQllNNcaKALRT8z/3Q0Z+vSkqnhIA6gHWFZn7ZZ0u8Zfv5rig+lyJNPZ6e+1uwxCtLABNe8G1NPUdgqhirblBDy0uhLaeiCcwOP/oiZ/M94+LxM2aPLoA9rwR47rviXUwiJ3rjQV4IZzGDuB/p1d7ttaBra39HMkqz5K1Y+I7T9mhCuoU4Rd88NHVx4NmseUQTStdulH6sy+shARMUg2M4PoXEKcWasJUd2s7CuuWa3ZHjL7EQePM1eqgUFPQloac98f3RUVAfVb9AbPhA4t/zewOZS1sYf1kxO6lrGw1P7qbXTmHUR5eTGeW/hKkZSbz5VZeN6ZtihQ3mogzmP+bsDaiuAfF2LQWijwQI7M7xjk7NBjvFfCkmnw1MymSC26vnIrb+ITfPefgi2M+uaL6HXsQvgdEL6VT1pTewD8494UJtPARf472npBWXrMjDpier711rMY5HtSwenq6KE0DHFp1bFXZ+gUZeMzvyIynB4HmyNGZpZf41Lh8uenOy49/ouO9aHMN8lcRLEz9aPQXyjAWT+FooXRQjT+BZWZ3A5t1IJB7Mfbxsah+7wE+CHOtpydL4bDR+wGIR4dm65YegeBviMN2FlCle6CnU2baDK23LTCYJalBV8K17a9ydxvHgelf0nvabTb/f93PQhjQ==
  isabelllong:
    comment: Isabell Long
    ssh_key: AAAAB3NzaC1yc2EAAAADAQABAAACAQC7HfCT0IusPqKxxEbap5yK1xBrKUpSB8B8wdiK5LgSWbaf78oY25nK5LE6i+NTFVt1Kxpd5uYs7/X3BquvdDrnkRVeJyfqDpJFSSSQBHiHSoVLv+EYzEYVRac7BT/riWSsNrGRGhAMMo84rWmSFmQxDBgJ4XMhv4Z0/2eBNRK+uZv+PHiOrWu8uAGmyr5s8bj93UqzafaoUaCcUBoWMGGk0pkmThlRAThpduvOvYqlX4YIbJ3vgEUfxCWhedmgbo2n4UXq8YISE46b5m9YmH31ZDifZ+WF3QXHsGQZmsB5TgSjTLHQGqoI7XpfTd1T1dGnIFT8ykBVrOFa7N5/AVn3AKBT3F63Ct9rMqdx9oIAn7d8OJQrFQfA1j+8fnUysEsO7lNALA/M0rAwAPwwC+YGwaspwTEzjFFK5/jPFhk+Z8n9PHZflxPN6bhRwv7PhK6tCmJ3jEogBSljE+/aLMS32HaaBjtxQO4AcjdxAB0ICsoY+Jl3kldJPudttrG6APufr0pSemNRPz6sVoxsph85CxdImKt+EDLpOxq25D+gQv2ACHRuDsqrZO2xDt357nqEoJNEL9W6BBDyeC2AIWA+59v4z7NveZf58Y8YhBZ5ZJdHOUP545V9tDBQDuttWYR/JoU4iPegKPuYZuayPYyYIcqSF2HIbbQ31qvyLSTs2w==
  rubenarakelyan:
    comment: Ruben Arakelyan
    ssh_key: AAAAB3NzaC1yc2EAAAADAQABAAACAQD3JSv9usRcPrHN45MEMr26sT4zsplKvzVhA0XouyUX9EwRqDFsSUtB0XIQcBzjTYxhdk7hgDEc6K91mVwFs9yyM2bp81kN0uue71f4kPQ+q+TIt/k44oejn0UCLTzdG01cI4CACZamFuSE4Jwa1K5ppJCAjmtmRuzfJrWOAXdOzYrGAm2mcg2KM+rPnOgLMDBaLY1aC4RTxg/fRHRbTg4Ghdck4ZrjkWkZmvPhODCoXi10beFA3V+ogCIGl8q2y4nHb2/AZyjSspmg9i11vBLmbCBfHgJISNssEaTflIblQfCLMqEy6iQNRSmke7oyI8bh28XU/hV7RsRRhvLOCXJeBXl+P/teh0OwkjeBRr+x8GYEPZlSiS5Yty7PljhRASYR5hZew3OHk6AwL+gtYUUtkO21lw0gCNQUZ2tpdUmbz8bRI2XGcSgHeeoK3XuKllBUBERKvwA7848b9cEwF2joF5Yraj/QEgJruC6ohGplhQOP+9lmklFIlljZfkWOxSGppsyuSrbknxPZTZrXJRvud3haYE4uK7nj1WG+Bxgid0lq6DDN3becs7RGE3V3CssIhgDeOkRbG8gVJnrHPtF2LbslnoDuXfeWXyJOFzwYC1SmsrfD/o/93LXiecnb/Fcu+aP0A3qkaJnR/rNYDXP8+cld4eusJHjOxNMsLFrtPQ==
  simonhughesdon:
    comment: Simon Hughesdon
    ssh_key: AAAAB3NzaC1yc2EAAAADAQABAAACAQCqbi1IsUFv6YjnhLTHY3pDhhGpl1chm657LpUU8Y/I3/4pUmtXF4N8HGoch5Be3VZDYrhWy7m9uqu2A7vVGn3Feq4TIZn2+hZ33A715iN4LSsqR/ccuOaHazb485RKgKbycFFwZVe4bxpuxy8rhqfQ9GckhQO2BrN5ZFmZVSiQ0hxh6fkWPILfp/bxI64c7MTOXeWt0rqPXJF7MHPQv1r47OiTzggYu+dk5eGPi1PUrU0npt3R3J1+c9lj6bNLpYRN6Ko+CzrOFXwp+mhxdv/1WZnKMPYpVU2W+97eZdUk6mOw2qUvYXvugCzOeVBrkhjW1xEEfybgJ8ud6rC1a60Dz1sPLO1uwaPP+VzC2GuvPP3WSS66HouaJkcjTHwT2TsLv0T21R3rFpae8FVDS4L2fw08SjR/IOqw3ZN3OARomomJBk4sojHC5UEnzY1ZIilyUS+DD8mtXYyZABXGuTREvDHCSvW1rcEpY16JKXceY4aLRs2kYYAvJdtpo5zUhnRTPpQRF8smtR9xElFhNi2+76cX/718Hf22Yu4IsY6p+4tHeQKQMF6/kzJavTIq/g0BnA/fDFGtfj2wx5qDyMwFkieYppgX4eW6Hyxhn+tph2uN4ntvhq1+hI30mHv2bs1+tqJq5Ze97hSMBCwzKZGdJe0LyGukjP72arw2hBEYfw==
  tijmenbrommet:
    comment: Tijmen Brommet
    ssh_key: AAAAB3NzaC1yc2EAAAADAQABAAACAQChxDnHtmrP+8wTqONV76/sHMAVkJeyeMs/yDNl4+bumjWum9+ZqKGTS6QvvZGh/rTKg5934ncv5xPv910NmisYW6SetjT4hWMZuqtnZKdLBN2YpSyqTjIWK0kpdKMS1linkeE5/6X38Ebi3UKP63VqTsDM7o4W2v/CshoIbC5+UKt7WjtcMsrijpul1leSw8gvwCtoq6z5N3vLqECTcv5/AoH+LxWDW/TYlywGqUD4Lfa1jJGf+D5ICK+StQMQ1RBU4ICby43htus+RR+NqMyDnQLkGdrVVT+/Tc2jQrj0wz78nVvJPULiG889NvgPrjXn1s9w45DuVl7i3a4c+X8yFGg6hcgW8pHcH+2sOPC5g1Y84ZARLj6yIr1ezdr6H5vSLiUBTauYuTOP3u2F5h1MKLHdXuhUKaV4jIj42jKpCwnKnd62uHs4oOkfIz4OFbVNCNDvUdBMYbRkJd8yDYHeSzbEFElSSSxBRtwMnfX1DJ21myNtI0AGzQMP27NYkroHQGLmbbHiLeWuFly8yuEmeeustdtQBwf6qMTcJeCXtAkzgTUDFYLsu3zBCZQN9wJt/OCBPrGbwn5cutaUMmn9RGEeUgqNYxzvKEwmF+1/QINAD3PZjk3byfh0u1LRYnppvQrfsg24wh5dtlTRzPfuPxtrWdKTxkPm3gLvqdJmvw==
  stevelaing:
    comment: Steve Laing
    ssh_key: AAAAB3NzaC1yc2EAAAADAQABAAACAQC1gVqgpzk0hswuVTlB6ICy7ee66ZpXKdDJubLrZ2+k129swujlwBTPmf+asS/2aSRXhC+rrDTflYaupQiGzuZZkO9sMzKoGVr9EyHZcjUZU7jWj66rGiBi1XaF3I1ZdiJjVRdrJ1jMcAnkkPeE4jA2LMuoO5h/Xlk5tiu3h3Wm6fa8QBvvpIf6MtqisRlsNqLUIt3+7K+MCO9ZgSdb8VTO8UKlfk6G0Lby5ptKFu2yhlujeJD3vCcO41XRuzLV3Pb/rRZPPJ8LNv5D+qV+TO+s1qJj6xrNH5kn48XveebSglu/YZWG0NYnDvbH7dKyKfKenJm/UGY/AYR3ZoCkQxx1eZlEkZGRv+U8BT4gIKmdc3VQYC30AMUF/trNDrWAJIKJ7f8XiT9Zc4NGRBSJ8OH+RWzJ7Q4prW1MxViN7qOmpgYdHTfnPYndR+j4n/3qkPO4+3R1rAPDxNReoMa30mUBWyKxkifp16CmY+kk6UdrYs1lnPbDL95EHpMlDAobKoRWXHIWA+J0luhZ0RcHbJA+n8u8bJgUw3KaFKerdjzy6dxGEMVTzkgACA4f9eePtwBVMTv+vZJZGOk5V96VrrMdhzMX7xmNW0twkRyxy7SOd9fUGqGqKAEC396d67HeH7IhJuq22rRC5CNWxJpITFPpVdMjWnYEYqYQcBl2d+9JTw==
